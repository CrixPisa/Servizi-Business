<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accedi - Servizi Business Italia</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9F1LD82S0S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9F1LD82S0S');
    </script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.75.0/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Back to Home -->
        <div class="mb-8">
            <a href="index.html" class="text-blue-600 hover:text-blue-700 inline-flex items-center">
                <i class="fas fa-arrow-left mr-2"></i>Torna alla Home
            </a>
        </div>

        <div class="max-w-md mx-auto">
            <!-- Logo/Brand -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center space-x-2 mb-4">
                    <i class="fas fa-calculator text-blue-600 text-4xl"></i>
                    <span class="text-3xl font-bold text-gray-800">Servizi Business</span>
                </div>
                <p class="text-gray-600">Accedi per usare i servizi avanzati</p>
            </div>

            <!-- Login/Register Card -->
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <!-- Tabs -->
                <div class="flex border-b mb-6">
                    <button id="loginTab" class="flex-1 py-3 font-semibold text-blue-600 border-b-2 border-blue-600">
                        Accedi
                    </button>
                    <button id="registerTab" class="flex-1 py-3 font-semibold text-gray-600">
                        Registrati
                    </button>
                </div>

                <!-- Login Form -->
                <div id="loginForm">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Bentornato!</h2>
                    
                    <form id="loginFormSubmit" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="loginEmail" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="tua@email.it" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <input type="password" id="loginPassword" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="••••••••" required>
                        </div>

                        <div class="flex items-center justify-between text-sm">
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span class="text-gray-600">Ricordami</span>
                            </label>
                            <a href="#" onclick="resetPassword()" class="text-blue-600 hover:underline text-sm">Hai dimenticato la password?</a>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold text-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>Accedi
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm text-gray-600">
                        Non hai un account? 
                        <button id="switchToRegister" class="text-blue-600 hover:text-blue-700 font-semibold">Registrati ora</button>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Crea Account Gratuito</h2>
                    
                    <form id="registerFormSubmit" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nome e Cognome</label>
                            <input type="text" id="registerName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="Mario Rossi" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="registerEmail" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="tua@email.it" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <input type="password" id="registerPassword" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="••••••••" required>
                            <p class="text-xs text-gray-500 mt-1">Minimo 6 caratteri</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Conferma Password</label>
                            <input type="password" id="registerPasswordConfirm" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="••••••••" required>
                        </div>

                        <div class="flex items-start">
                            <input type="checkbox" id="termsAccept" class="mt-1 mr-2" required>
                            <label for="termsAccept" class="text-sm text-gray-600">
                                Accetto i <a href="terms.html" class="text-blue-600 hover:underline">Termini di Servizio</a> e la <a href="privacy.html" class="text-blue-600 hover:underline">Privacy Policy</a>
                            </label>
                        </div>

                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold text-lg">
                            <i class="fas fa-user-plus mr-2"></i>Registrati Gratis
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm text-gray-600">
                        Hai già un account? 
                        <button id="switchToLogin" class="text-blue-600 hover:text-blue-700 font-semibold">Accedi</button>
                    </div>
                </div>
            </div>

            <!-- Features -->
            <div class="mt-8 bg-white rounded-xl p-6 shadow-lg">
                <h3 class="font-bold text-gray-800 mb-4 text-center">
                    <i class="fas fa-gift text-blue-600 mr-2"></i>Cosa ottieni gratuitamente:
                </h3>
                <ul class="space-y-3 text-sm text-gray-700">
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        Generatore fatture elettroniche illimitato
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        Generatore preventivi professionali
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        Scarica PDF di fatture e preventivi
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        Dashboard con statistiche
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        Sempre gratis, nessun costo nascosto
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const switchToRegister = document.getElementById('switchToRegister');
        const switchToLogin = document.getElementById('switchToLogin');

        function showLogin() {
            loginTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            loginTab.classList.remove('text-gray-600');
            registerTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            registerTab.classList.add('text-gray-600');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        }

        function showRegister() {
            registerTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            registerTab.classList.remove('text-gray-600');
            loginTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            loginTab.classList.add('text-gray-600');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        }

        loginTab.addEventListener('click', showLogin);
        registerTab.addEventListener('click', showRegister);
        switchToRegister.addEventListener('click', showRegister);
        switchToLogin.addEventListener('click', showLogin);

        // Gestione del reset password
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('reset') === 'true') {
            const newPasswordForm = document.createElement('div');
            newPasswordForm.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Reimposta Password</h2>
                <form id="resetPasswordForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nuova Password</label>
                        <input type="password" id="newPassword" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="••••••••" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Conferma Nuova Password</label>
                        <input type="password" id="newPasswordConfirm" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold text-lg">
                        <i class="fas fa-lock mr-2"></i>Reimposta Password
                    </button>
                </form>
            `;
            document.getElementById('loginForm').innerHTML = '';
            document.getElementById('loginForm').appendChild(newPasswordForm);

            document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;
                if (newPassword !== newPasswordConfirm) {
                    alert('❌ Le password non corrispondono!');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('❌ La password deve essere di almeno 6 caratteri!');
                    return;
                }
                try {
                    const { error } = await supabase.auth.updateUser({ password: newPassword });
                    if (error) {
                        alert('❌ Errore: ' + error.message);
                    } else {
                        alert('✅ Password aggiornata con successo!');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    alert('❌ Errore di connessione: ' + error.message);
                }
            });
        }

        // LOGIN CON SUPABASE
        document.getElementById('loginFormSubmit').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Disabilita bottone
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Accesso in corso...';
            
            try {
                const result = await supabaseLogin(email, password);
                
                if (result.success) {
                    alert('✅ Accesso effettuato con successo!');
                    window.location.href = 'genera-fatture.html';
                } else {
                    alert('❌ ' + result.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Accedi';
                }
            } catch (error) {
                alert('❌ Errore di connessione');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Accedi';
            }
        });

        // REGISTRAZIONE CON SUPABASE
        document.getElementById('registerFormSubmit').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const submitBtn = this.querySelector('button[type="submit"]');

            // Validation
            if (password.length < 6) {
                alert('❌ La password deve essere di almeno 6 caratteri!');
                return;
            }

            if (password !== passwordConfirm) {
                alert('❌ Le password non corrispondono!');
                return;
            }
            
            // Disabilita bottone
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registrazione in corso...';
            
            try {
                const result = await supabaseRegister(name, email, password);
                
                if (result.success) {
                    alert('✅ Registrazione completata! Controlla la tua email per confermare l\'account.');
                    
                    // Switch to login tab
                    showLogin();
                    document.getElementById('registerForm').reset();
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Registrati Gratis';
                } else {
                    alert('❌ ' + result.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Registrati Gratis';
                }
            } catch (error) {
                alert('❌ Errore di connessione');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Registrati Gratis';
            }
        });

        // Controllo autenticazione all'avvio (eseguito una sola volta)
        (function checkAuthOnLoad() {
            if (typeof supabaseIsLoggedIn === 'function') {
                supabaseIsLoggedIn().then(isLoggedIn => {
                    if (isLoggedIn && !urlParams.get('reset')) {
                        const goToDashboard = confirm('Sei già loggato. Vuoi andare al generatore fatture?');
                        if (goToDashboard) {
                            window.location.href = 'genera-fatture.html';
                        }
                    }
                }).catch(err => {
                    console.log('Auth check skipped:', err);
                });
            }
        })();

        // RESET PASSWORD FUNCTION
        async function resetPassword() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                alert('⚠️ Inserisci la tua email prima di richiedere il reset della password!');
                document.getElementById('loginEmail').focus();
                return;
            }
            
            if (!email.includes('@')) {
                alert('❌ Inserisci un indirizzo email valido!');
                return;
            }
            
            const confirmed = confirm(`📧 Invieremo un'email a:\n${email}\n\nPer reimpostare la password.\n\nContinuare?`);
            
            if (!confirmed) return;
            
            try {
                const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/login.html?reset=true',
                });
                
                if (error) {
                    if (error.message.includes('Email') || error.message.includes('SMTP')) {
                        alert('⚠️ Sistema email temporaneamente non disponibile.\n\nContatta il supporto: info@servizi-business.com\n\nOppure crea un nuovo account.');
                    } else {
                        alert('❌ Errore: ' + error.message);
                    }
                } else {
                    alert('✅ Email inviata!\n\nControlla la tua casella di posta (anche spam) e clicca sul link per reimpostare la password.\n\nSe non ricevi l\'email entro 5 minuti, contattaci: info@servizi-business.com');
                }
            } catch (error) {
                alert('⚠️ Sistema email temporaneamente non disponibile.\n\nPer assistenza: info@servizi-business.com\n\nOppure crea un nuovo account se hai dimenticato i dati.');
            }
        }
    </script>
</body>
</html>