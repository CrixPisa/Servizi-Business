<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gestione Corrispettivi Online - Registra le vendite giornaliere, calcola IVA automaticamente e genera report per il commercialista.">
    <title>Corrispettivi Online - Gestione Vendite Giornaliere</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="tax-systems.js"></script>
    <script src="i18n.js"></script>
    <script src="country-selector.js"></script>
    <script src="supabase-config.js"></script>
</head>
<body class="bg-gray-50">
    
    <!-- Protezione Pagina -->
    <script>
        (async function() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                const currentUrl = encodeURIComponent(window.location.href);
                alert('Devi essere registrato per usare questo strumento.');
                window.location.href = `login.html?redirect=${currentUrl}`;
            }
        })();
    </script>
    
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <i class="fas fa-cash-register text-green-600 text-2xl"></i>
                    <span class="text-xl font-bold text-gray-800">Servizi Business</span>
                </a>
                
                <div class="flex items-center gap-4">
                    <div id="headerCountrySelector"></div>
                    
                    <div class="flex gap-1 border-l pl-4">
                        <button class="lang-btn px-3 py-1 rounded text-sm" data-lang="it">IT</button>
                        <button class="lang-btn px-3 py-1 rounded text-sm" data-lang="en">EN</button>
                        <button class="lang-btn px-3 py-1 rounded text-sm" data-lang="de">DE</button>
                    </div>
                    
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-home mr-2"></i><span data-i18n="home">Home</span>
                    </a>
                    
                    <div id="authButtonsContainer"></div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header Section -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-cash-register text-green-600 mr-3"></i>
                    Corrispettivi Online
                </h1>
                <p class="text-xl text-gray-600">Gestisci le tue vendite giornaliere in modo semplice e professionale</p>
                <div class="mt-4 inline-flex items-center bg-green-50 px-4 py-2 rounded-lg">
                    <i class="fas fa-globe mr-2 text-green-600"></i>
                    <span class="text-green-800 font-semibold" id="currentCountryName"></span>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="bg-white rounded-xl shadow-sm mb-6">
                <div class="flex border-b overflow-x-auto">
                    <button class="tab-btn active px-6 py-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-green-600 transition whitespace-nowrap" data-tab="register">
                        <i class="fas fa-plus-circle mr-2"></i>Registra Vendita
                    </button>
                    <button class="tab-btn px-6 py-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-green-600 transition whitespace-nowrap" data-tab="history">
                        <i class="fas fa-history mr-2"></i>Storico
                    </button>
                    <button class="tab-btn px-6 py-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-green-600 transition whitespace-nowrap" data-tab="stats">
                        <i class="fas fa-chart-bar mr-2"></i>Statistiche
                    </button>
                    <button class="tab-btn px-6 py-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-green-600 transition whitespace-nowrap" data-tab="export">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>

            <!-- Tab: Registra Vendita -->
            <div id="tab-register" class="tab-content">
                <div class="grid lg:grid-cols-3 gap-6">
                    
                    <!-- Form Registrazione -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                                <i class="fas fa-edit text-green-600 mr-2"></i>
                                Nuova Vendita
                            </h2>
                            
                            <form id="saleForm" class="space-y-6">
                                <!-- Data -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Data Vendita</label>
                                    <input type="date" id="saleDate" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none" required>
                                </div>

                                <!-- Importo -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Importo Totale (Lordo)</label>
                                    <div class="relative">
                                        <span id="currencySymbol" class="absolute left-4 top-4 text-gray-400 text-xl">€</span>
                                        <input type="number" id="saleAmount" class="w-full pl-12 pr-4 py-4 text-2xl border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none" placeholder="100.00" step="0.01" min="0" required>
                                    </div>
                                </div>

                                <!-- Aliquota IVA -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">
                                        <span id="vatLabelName">IVA</span> - Aliquota
                                    </label>
                                    <select id="vatRate" class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none" required>
                                    </select>
                                </div>

                                <!-- Descrizione -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Descrizione (opzionale)</label>
                                    <textarea id="saleDescription" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none" rows="3" placeholder="Es: Vendite miste, Abbigliamento, Alimentari..."></textarea>
                                </div>

                                <!-- Buttons -->
                                <div class="flex gap-4">
                                    <button type="submit" class="flex-1 bg-green-600 text-white px-6 py-4 rounded-lg font-semibold text-lg hover:bg-green-700 transition">
                                        <i class="fas fa-save mr-2"></i>Salva Vendita
                                    </button>
                                    <button type="button" id="resetForm" class="px-6 py-4 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition">
                                        <i class="fas fa-redo mr-2"></i>Reset
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Riepilogo Vendita -->
                    <div class="lg:col-span-1">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-lg p-6 sticky top-24">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-calculator text-green-600 mr-2"></i>
                                Riepilogo
                            </h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-sm text-gray-600 mb-1">Importo Lordo</div>
                                    <div id="summaryGross" class="text-2xl font-bold text-gray-800">€ 0.00</div>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-sm text-gray-600 mb-1" id="vatName">IVA</div>
                                    <div id="summaryVat" class="text-xl font-bold text-green-600">€ 0.00</div>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-sm text-gray-600 mb-1">Imponibile</div>
                                    <div id="summaryNet" class="text-2xl font-bold text-gray-800">€ 0.00</div>
                                </div>
                                
                                <div class="text-sm text-gray-600 mt-4">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    I dati vengono salvati automaticamente
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Storico -->
            <div id="tab-history" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-list text-green-600 mr-2"></i>
                            Storico Vendite
                        </h2>
                        
                        <!-- Filtri -->
                        <div class="flex gap-3">
                            <select id="filterMonth" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none">
                                <option value="">Tutti i mesi</option>
                                <option value="1">Gennaio</option>
                                <option value="2">Febbraio</option>
                                <option value="3">Marzo</option>
                                <option value="4">Aprile</option>
                                <option value="5">Maggio</option>
                                <option value="6">Giugno</option>
                                <option value="7">Luglio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Settembre</option>
                                <option value="10">Ottobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">Dicembre</option>
                            </select>
                            <select id="filterYear" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none">
                                <option value="">Tutti gli anni</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabella -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrizione</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Imponibile</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">IVA %</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">IVA</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Totale</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-2"></i>
                                        <p>Nessuna vendita registrata</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Totali -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Totale Imponibile</div>
                            <div id="totalNet" class="text-xl font-bold text-gray-800">€ 0.00</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Totale IVA</div>
                            <div id="totalVat" class="text-xl font-bold text-green-600">€ 0.00</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Totale Lordo</div>
                            <div id="totalGross" class="text-xl font-bold text-gray-800">€ 0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Statistiche -->
            <div id="tab-stats" class="tab-content hidden">
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Grafico Andamento -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-chart-line text-green-600 mr-2"></i>
                            Andamento Vendite
                        </h3>
                        <canvas id="salesChart"></canvas>
                    </div>

                    <!-- Grafico IVA per Aliquota -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-chart-pie text-green-600 mr-2"></i>
                            IVA per Aliquota
                        </h3>
                        <canvas id="vatChart"></canvas>
                    </div>

                    <!-- KPIs -->
                    <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6">
                            <div class="text-sm text-blue-600 font-semibold mb-2">Vendite Totali</div>
                            <div id="kpiTotalSales" class="text-3xl font-bold text-blue-900">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6">
                            <div class="text-sm text-green-600 font-semibold mb-2">Fatturato</div>
                            <div id="kpiRevenue" class="text-3xl font-bold text-green-900">€ 0</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6">
                            <div class="text-sm text-purple-600 font-semibold mb-2">Media Vendita</div>
                            <div id="kpiAverage" class="text-3xl font-bold text-purple-900">€ 0</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6">
                            <div class="text-sm text-orange-600 font-semibold mb-2">IVA Totale</div>
                            <div id="kpiTotalVat" class="text-3xl font-bold text-orange-900">€ 0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Export -->
            <div id="tab-export" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-file-download text-green-600 mr-2"></i>
                        Esporta Dati
                    </h2>

                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Export Excel -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-green-600 hover:shadow-lg transition cursor-pointer" onclick="exportToExcel()">
                            <div class="text-center">
                                <i class="fas fa-file-excel text-6xl text-green-600 mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Excel (.xlsx)</h3>
                                <p class="text-gray-600 mb-4">Perfetto per il commercialista</p>
                                <button class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                    <i class="fas fa-download mr-2"></i>Scarica Excel
                                </button>
                            </div>
                        </div>

                        <!-- Export CSV -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-blue-600 hover:shadow-lg transition cursor-pointer" onclick="exportToCSV()">
                            <div class="text-center">
                                <i class="fas fa-file-csv text-6xl text-blue-600 mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">CSV</h3>
                                <p class="text-gray-600 mb-4">Compatibile con tutti i programmi</p>
                                <button class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                    <i class="fas fa-download mr-2"></i>Scarica CSV
                                </button>
                            </div>
                        </div>

                        <!-- Export PDF -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-red-600 hover:shadow-lg transition cursor-pointer" onclick="exportToPDF()">
                            <div class="text-center">
                                <i class="fas fa-file-pdf text-6xl text-red-600 mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">PDF</h3>
                                <p class="text-gray-600 mb-4">Report professionale</p>
                                <button class="w-full bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                                    <i class="fas fa-download mr-2"></i>Scarica PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Opzioni Export -->
                    <div class="mt-8 bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Opzioni Export</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Periodo Da</label>
                                <input type="date" id="exportDateFrom" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Periodo A</label>
                                <input type="date" id="exportDateTo" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <style>
        .tab-btn {
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #16a34a;
            border-bottom-color: #16a34a;
        }
        .lang-btn {
            background: #f3f4f6;
            color: #6b7280;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: #3b82f6;
            color: white;
        }
    </style>

    <script src="auth.js"></script>
    
    <script>
    // Popola aliquote IVA dinamicamente
    document.addEventListener('DOMContentLoaded', function() {
        const currentCountry = getCurrentCountry();
        const taxSystem = TAX_SYSTEMS[currentCountry];
        
        // Popola select aliquote
        const vatRateSelect = document.getElementById('vatRate');
        vatRateSelect.innerHTML = '';
        
        taxSystem.vat.rates.forEach(rate => {
            const option = document.createElement('option');
            option.value = rate.value;
            // Usa la traduzione se disponibile, altrimenti usa labelKey
            const label = TRANSLATIONS[currentLanguage] && TRANSLATIONS[currentLanguage][rate.labelKey] 
                ? TRANSLATIONS[currentLanguage][rate.labelKey]
                : rate.labelKey;
            option.textContent = `${rate.value}% - ${label}`;
            vatRateSelect.appendChild(option);
        });
        
        // Imposta simbolo valuta
        document.getElementById('currencySymbol').textContent = taxSystem.currencySymbol;
        document.getElementById('vatLabelName').textContent = taxSystem.vat.name;
        document.getElementById('vatName').textContent = taxSystem.vat.name;
        
        // Update country name
        const countryNames = {
            'it': 'Italia', 'de': 'Germania', 'fr': 'Francia',
            'es': 'Spagna', 'uk': 'Regno Unito', 'us': 'Stati Uniti', 'au': 'Australia'
        };
        document.getElementById('currentCountryName').textContent = countryNames[currentCountry] || currentCountry.toUpperCase();
        
        // Calcolo in tempo reale
        const amountInput = document.getElementById('saleAmount');
        const vatSelect = document.getElementById('vatRate');
        
        function calculateSummary() {
            const gross = parseFloat(amountInput.value) || 0;
            const vatRate = parseFloat(vatSelect.value) || 0;
            
            const vat = gross * vatRate / (100 + vatRate);
            const net = gross - vat;
            
            document.getElementById('summaryGross').textContent = `${taxSystem.currencySymbol} ${gross.toFixed(2)}`;
            document.getElementById('summaryVat').textContent = `${taxSystem.currencySymbol} ${vat.toFixed(2)}`;
            document.getElementById('summaryNet').textContent = `${taxSystem.currencySymbol} ${net.toFixed(2)}`;
        }
        
        amountInput.addEventListener('input', calculateSummary);
        vatSelect.addEventListener('change', calculateSummary);
        
        // Set today's date
        document.getElementById('saleDate').valueAsDate = new Date();
    });
    </script>
    
    <script src="corrispettivi.js"></script>
</body>
</html>
