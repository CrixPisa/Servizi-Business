<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Genera preventivi professionali online gratis in PDF. Crea preventivi personalizzati in pochi minuti.">
    <meta name="keywords" content="preventivi online, generatore preventivi, preventivi professionali, preventivi PDF gratis">
    <title>Generatore Preventivi Online Gratis - Servizi Business</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9F1LD82S0S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9F1LD82S0S');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="index.html" class="flex items-center space-x-2">
                    <i class="fas fa-calculator text-blue-600 text-2xl"></i>
                    <span class="text-xl font-bold text-gray-800">Servizi Business</span>
                </a>
                <div class="flex items-center gap-4">
                    <a href="lista-fatture.html" class="text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-list mr-2"></i>I Miei Preventivi
                    </a>
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-12">
        <!-- Breadcrumb -->
        <div class="mb-6">
            <a href="index.html" class="text-blue-600 hover:underline">Home</a>
            <span class="text-gray-400 mx-2">/</span>
            <span class="text-gray-600">Genera Preventivo</span>
        </div>

        <div class="max-w-5xl mx-auto">
            <!-- Title -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">
                    📄 Generatore Preventivi
                </h1>
                <p class="text-xl text-gray-600">Crea preventivi professionali in pochi minuti</p>
            </div>

            <!-- Info Banner -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500 p-4 mb-8 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-green-600 text-xl mr-3 mt-1"></i>
                    <div>
                        <p class="text-green-800 font-semibold">✨ Preventivo Professionale</p>
                        <p class="text-green-700 text-sm mt-1">
                            Un preventivo è una proposta commerciale non vincolante. Include validità offerta e condizioni.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <form id="preventivoForm">
                    <!-- Dati Azienda -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-building text-blue-600 mr-3"></i>
                            I Tuoi Dati
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Nome/Ragione Sociale *</label>
                                <input type="text" id="aziendaNome" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                       placeholder="La Tua Azienda SRL">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Partita IVA / CF *</label>
                                <input type="text" id="aziendaPiva" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                       placeholder="12345678901">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Indirizzo *</label>
                                <input type="text" id="aziendaIndirizzo" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                       placeholder="Via Roma 123">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Città *</label>
                                <input type="text" id="aziendaCitta" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                       placeholder="Milano (MI) 20100">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="aziendaEmail" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                       placeholder="info@tuaazienda.it">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Telefono</label>
                                <input type="tel" id="aziendaTelefono" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                       placeholder="+39 123 456 7890">
                            </div>
                        </div>
                    </div>

                    <hr class="my-8">

                    <!-- Dati Cliente -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-user text-green-600 mr-3"></i>
                            Dati Cliente
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Nome/Ragione Sociale *</label>
                                <input type="text" id="clienteNome" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none"
                                       placeholder="Cliente SRL">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Partita IVA / CF</label>
                                <input type="text" id="clientePiva" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none"
                                       placeholder="98765432109">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Indirizzo</label>
                                <input type="text" id="clienteIndirizzo" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none"
                                       placeholder="Via Cliente 456">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Città</label>
                                <input type="text" id="clienteCitta" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-600 focus:outline-none"
                                       placeholder="Roma (RM) 00100">
                            </div>
                        </div>
                    </div>

                    <hr class="my-8">

                    <!-- Dettagli Preventivo -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-file-alt text-purple-600 mr-3"></i>
                            Dettagli Preventivo
                        </h2>
                        
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Numero Preventivo *</label>
                                <input type="text" id="numeroPreventivo" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none"
                                       placeholder="PREV-001">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Data Emissione *</label>
                                <input type="date" id="dataEmissione" required 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Validità (giorni)</label>
                                <input type="number" id="validita" value="30" 
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none"
                                       placeholder="30">
                            </div>
                        </div>

                        <!-- Items -->
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-3">Servizi / Prodotti</label>
                            <div id="itemsContainer">
                                <!-- Items dinamici -->
                            </div>
                            <button type="button" onclick="addItem()" 
                                    class="mt-3 bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 transition">
                                <i class="fas fa-plus mr-2"></i>Aggiungi Riga
                            </button>
                        </div>

                        <!-- Note -->
                        <div class="mt-6">
                            <label class="block text-gray-700 font-semibold mb-2">Note / Condizioni</label>
                            <textarea id="note" rows="4" 
                                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none"
                                      placeholder="Condizioni di pagamento, tempi di consegna, etc..."></textarea>
                        </div>
                    </div>

                    <!-- Totali -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 mb-6">
                        <div class="flex justify-between items-center text-2xl font-bold">
                            <span class="text-gray-800">TOTALE PREVENTIVO:</span>
                            <span id="totalePreventivo" class="text-purple-700">€ 0,00</span>
                        </div>
                        <p class="text-sm text-purple-800 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Questo è un preventivo non vincolante
                        </p>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-4">
                        <button type="button" onclick="resetForm()" 
                                class="flex-1 bg-gray-200 text-gray-700 px-6 py-4 rounded-lg font-semibold hover:bg-gray-300 transition">
                            <i class="fas fa-redo mr-2"></i>Reset
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 rounded-lg font-semibold hover:from-purple-700 hover:to-purple-800 transition">
                            <i class="fas fa-file-pdf mr-2"></i>Genera PDF
                        </button>
                    </div>
                </form>
            </div>

            <!-- Info Section -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    Cos'è un Preventivo?
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-gray-800 mb-2">✅ Preventivo</h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>• Proposta commerciale</li>
                            <li>• Non vincolante</li>
                            <li>• Ha una validità (es: 30 giorni)</li>
                            <li>• NO valore fiscale</li>
                            <li>• Si trasforma in fattura dopo accettazione</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="font-bold text-gray-800 mb-2">📄 Fattura</h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>• Documento fiscale</li>
                            <li>• Vincolante</li>
                            <li>• Obbligo di pagamento</li>
                            <li>• Valore fiscale/legale</li>
                            <li>• Emessa dopo lavoro svolto</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-6 bg-blue-50 border-l-4 border-blue-400 p-4">
                    <p class="text-sm text-gray-700">
                        <strong>💡 Tip:</strong> Usa i preventivi per formalizzare le offerte ai clienti. 
                        Una volta accettato, genera la fattura con <a href="genera-fatture.html" class="text-blue-600 underline">il nostro generatore</a>!
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2025 Servizi Business Italia. Tutti i diritti riservati.</p>
        </div>
    </footer>

    <script>
        // Set today's date
        document.getElementById('dataEmissione').valueAsDate = new Date();

        // Add initial item
        window.addEventListener('load', () => {
            addItem();
        });

        let itemCount = 0;

        function addItem() {
            itemCount++;
            const container = document.getElementById('itemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-gray-50 p-4 rounded-lg mb-3';
            itemDiv.id = `item-${itemCount}`;
            itemDiv.innerHTML = `
                <div class="grid grid-cols-12 gap-3">
                    <div class="col-span-12 md:col-span-5">
                        <input type="text" class="item-desc w-full px-3 py-2 border border-gray-300 rounded focus:border-purple-600 focus:outline-none" 
                               placeholder="Descrizione servizio/prodotto" onchange="calculateTotal()">
                    </div>
                    <div class="col-span-4 md:col-span-2">
                        <input type="number" class="item-qty w-full px-3 py-2 border border-gray-300 rounded focus:border-purple-600 focus:outline-none" 
                               placeholder="Q.tà" value="1" min="1" onchange="calculateTotal()">
                    </div>
                    <div class="col-span-4 md:col-span-2">
                        <input type="number" class="item-price w-full px-3 py-2 border border-gray-300 rounded focus:border-purple-600 focus:outline-none" 
                               placeholder="Prezzo" step="0.01" min="0" onchange="calculateTotal()">
                    </div>
                    <div class="col-span-3 md:col-span-2">
                        <input type="text" class="item-total w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded text-right font-semibold" 
                               placeholder="Totale" readonly>
                    </div>
                    <div class="col-span-1 md:col-span-1 flex items-center">
                        <button type="button" onclick="removeItem(${itemCount})" 
                                class="text-red-600 hover:text-red-800 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(itemDiv);
        }

        function removeItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item && document.querySelectorAll('[id^="item-"]').length > 1) {
                item.remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('[id^="item-"]').forEach(item => {
                const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const itemTotal = qty * price;
                item.querySelector('.item-total').value = '€ ' + itemTotal.toFixed(2);
                total += itemTotal;
            });
            document.getElementById('totalePreventivo').textContent = '€ ' + total.toFixed(2).replace('.', ',');
        }

        function resetForm() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                document.getElementById('preventivoForm').reset();
                document.getElementById('itemsContainer').innerHTML = '';
                itemCount = 0;
                addItem();
                calculateTotal();
                document.getElementById('dataEmissione').valueAsDate = new Date();
            }
        }

        document.getElementById('preventivoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generaPDF();
        });

        function generaPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Colors
            const primaryColor = [147, 51, 234]; // Purple
            const secondaryColor = [100, 100, 100];

            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('PREVENTIVO', 105, 25, { align: 'center' });

            // Reset color
            doc.setTextColor(0, 0, 0);

            // Dati Azienda
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DA:', 15, 50);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('aziendaNome').value, 15, 56);
            doc.text('P.IVA: ' + document.getElementById('aziendaPiva').value, 15, 62);
            doc.text(document.getElementById('aziendaIndirizzo').value, 15, 68);
            doc.text(document.getElementById('aziendaCitta').value, 15, 74);
            if (document.getElementById('aziendaEmail').value) {
                doc.text(document.getElementById('aziendaEmail').value, 15, 80);
            }
            if (document.getElementById('aziendaTelefono').value) {
                doc.text(document.getElementById('aziendaTelefono').value, 15, 86);
            }

            // Dati Cliente
            doc.setFont(undefined, 'bold');
            doc.text('A:', 120, 50);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('clienteNome').value, 120, 56);
            if (document.getElementById('clientePiva').value) {
                doc.text('P.IVA: ' + document.getElementById('clientePiva').value, 120, 62);
            }
            if (document.getElementById('clienteIndirizzo').value) {
                doc.text(document.getElementById('clienteIndirizzo').value, 120, 68);
            }
            if (document.getElementById('clienteCitta').value) {
                doc.text(document.getElementById('clienteCitta').value, 120, 74);
            }

            // Info Preventivo
            let yPos = 100;
            doc.setFontSize(9);
            doc.text('Preventivo N°: ' + document.getElementById('numeroPreventivo').value, 15, yPos);
            doc.text('Data: ' + document.getElementById('dataEmissione').value, 15, yPos + 6);
            const validita = document.getElementById('validita').value;
            doc.text('Valido fino al: ' + calcolaDataScadenza(validita), 15, yPos + 12);

            // Table Header
            yPos = 125;
            doc.setFillColor(147, 51, 234);
            doc.rect(15, yPos, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Descrizione', 17, yPos + 5);
            doc.text('Q.tà', 130, yPos + 5);
            doc.text('Prezzo', 150, yPos + 5);
            doc.text('Totale', 175, yPos + 5);

            // Items
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            yPos += 12;

            document.querySelectorAll('[id^="item-"]').forEach(item => {
                const desc = item.querySelector('.item-desc').value;
                const qty = item.querySelector('.item-qty').value;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const total = qty * price;

                doc.text(desc, 17, yPos);
                doc.text(qty.toString(), 130, yPos);
                doc.text('€ ' + price.toFixed(2), 150, yPos);
                doc.text('€ ' + total.toFixed(2), 175, yPos);
                yPos += 6;
            });

            // Total
            yPos += 10;
            doc.setFillColor(147, 51, 234);
            doc.rect(140, yPos - 5, 55, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('TOTALE:', 145, yPos);
            doc.text(document.getElementById('totalePreventivo').textContent, 185, yPos, { align: 'right' });

            // Note
            const note = document.getElementById('note').value;
            if (note) {
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                yPos += 15;
                doc.text('Note / Condizioni:', 15, yPos);
                doc.setFont(undefined, 'normal');
                const splitNote = doc.splitTextToSize(note, 180);
                yPos += 5;
                doc.text(splitNote, 15, yPos);
            }

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Questo preventivo non costituisce documento fiscale ed è valido fino alla data indicata.', 105, 280, { align: 'center' });
            doc.text('Generato con Servizi Business - servizi-business.com', 105, 285, { align: 'center' });

            // Save
            const filename = `Preventivo_${document.getElementById('numeroPreventivo').value}.pdf`;
            doc.save(filename);

            // Success message
            alert('✅ Preventivo generato con successo!\n\nIl PDF è stato scaricato.');
        }

        function calcolaDataScadenza(giorni) {
            const data = new Date(document.getElementById('dataEmissione').value);
            data.setDate(data.getDate() + parseInt(giorni));
            return data.toLocaleDateString('it-IT');
        }
    </script>

    <!-- Auth Protection -->
    <script src="auth.js"></script>
    <script>
        if (!isLoggedIn()) {
            alert('⚠️ Devi essere registrato per usare il generatore preventivi!\n\nRegistrazione GRATUITA.');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
