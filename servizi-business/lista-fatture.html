<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Mie Fatture - Servizi Business Italia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="auth.js"></script>
</head>
<body class="bg-gray-50" data-protected="true">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="index.html" class="flex items-center space-x-2">
                    <i class="fas fa-calculator text-blue-600 text-2xl"></i>
                    <span class="text-xl font-bold text-gray-800">Servizi Business</span>
                </a>
                <div id="userInfo" class="flex items-center gap-4">
                    <a href="genera-fatture.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>Nuova Fattura
                    </a>
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Le Mie Fatture</h1>
                <p class="text-gray-600">Gestisci tutte le tue fatture generate</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Totale Fatture</p>
                            <p id="totalInvoices" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <i class="fas fa-file-invoice text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Fatturato Totale</p>
                            <p id="totalRevenue" class="text-3xl font-bold text-green-600">€ 0</p>
                        </div>
                        <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <i class="fas fa-euro-sign text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Questo Mese</p>
                            <p id="thisMonth" class="text-3xl font-bold text-purple-600">€ 0</p>
                        </div>
                        <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <i class="fas fa-calendar-alt text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Bozze</p>
                            <p id="totalDrafts" class="text-3xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="bg-orange-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <i class="fas fa-save text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-md mb-6">
                <div class="border-b">
                    <div class="flex">
                        <button id="completedTab" class="px-6 py-4 font-semibold text-blue-600 border-b-2 border-blue-600">
                            Completate
                        </button>
                        <button id="draftsTab" class="px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                            Bozze
                        </button>
                        <button id="customersTab" class="px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                            Clienti Salvati
                        </button>
                    </div>
                </div>

                <!-- Completed Invoices -->
                <div id="completedContent" class="p-6">
                    <div id="invoicesList" class="space-y-4">
                        <!-- Invoices will be loaded here -->
                    </div>
                    <div id="noInvoices" class="text-center py-12 hidden">
                        <i class="fas fa-file-invoice text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg">Nessuna fattura completata</p>
                        <a href="genera-fatture.html" class="inline-block mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                            Crea la tua prima fattura
                        </a>
                    </div>
                </div>

                <!-- Drafts -->
                <div id="draftsContent" class="p-6 hidden">
                    <div id="draftsList" class="space-y-4">
                        <!-- Drafts will be loaded here -->
                    </div>
                    <div id="noDrafts" class="text-center py-12 hidden">
                        <i class="fas fa-save text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg">Nessuna bozza salvata</p>
                    </div>
                </div>

                <!-- Customers -->
                <div id="customersContent" class="p-6 hidden">
                    <div id="customersList" class="grid md:grid-cols-2 gap-4">
                        <!-- Customers will be loaded here -->
                    </div>
                    <div id="noCustomers" class="text-center py-12 hidden">
                        <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg">Nessun cliente salvato</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                <h3 class="font-bold text-blue-900 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>Informazioni
                </h3>
                <ul class="space-y-2 text-sm text-blue-800">
                    <li><i class="fas fa-check text-green-600 mr-2"></i>Le fatture sono salvate localmente nel tuo browser</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i>Puoi scaricare il PDF di ogni fattura in qualsiasi momento</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i>I dati rimangono privati e non vengono inviati a server esterni</li>
                    <li><i class="fas fa-exclamation-triangle text-orange-600 mr-2"></i>Se cancelli i dati del browser, perderai le fatture salvate</li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        // Tab management
        document.getElementById('completedTab').addEventListener('click', () => switchTab('completed'));
        document.getElementById('draftsTab').addEventListener('click', () => switchTab('drafts'));
        document.getElementById('customersTab').addEventListener('click', () => switchTab('customers'));

        function switchTab(tab) {
            // Reset all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-600');
            });
            document.querySelectorAll('[id$="Content"]').forEach(content => {
                content.classList.add('hidden');
            });

            // Activate selected tab
            if (tab === 'completed') {
                document.getElementById('completedTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('completedTab').classList.remove('text-gray-600');
                document.getElementById('completedContent').classList.remove('hidden');
                loadInvoices();
            } else if (tab === 'drafts') {
                document.getElementById('draftsTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('draftsTab').classList.remove('text-gray-600');
                document.getElementById('draftsContent').classList.remove('hidden');
                loadDrafts();
            } else if (tab === 'customers') {
                document.getElementById('customersTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('customersTab').classList.remove('text-gray-600');
                document.getElementById('customersContent').classList.remove('hidden');
                loadCustomers();
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadInvoices();
        });

        function loadStats() {
            const history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
            const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '[]');

            document.getElementById('totalInvoices').textContent = history.length;
            document.getElementById('totalDrafts').textContent = drafts.length;

            // Calculate total revenue
            const totalRevenue = history.reduce((sum, inv) => {
                const invTotal = inv.items.reduce((itemSum, item) => {
                    const subtotal = item.quantity * item.price;
                    const vat = subtotal * (item.vat / 100);
                    return itemSum + subtotal + vat;
                }, 0);
                return sum + invTotal;
            }, 0);

            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

            // This month revenue
            const now = new Date();
            const thisMonthRevenue = history.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getMonth() === now.getMonth() && invDate.getFullYear() === now.getFullYear();
            }).reduce((sum, inv) => {
                const invTotal = inv.items.reduce((itemSum, item) => {
                    const subtotal = item.quantity * item.price;
                    const vat = subtotal * (item.vat / 100);
                    return itemSum + subtotal + vat;
                }, 0);
                return sum + invTotal;
            }, 0);

            document.getElementById('thisMonth').textContent = formatCurrency(thisMonthRevenue);
        }

        function loadInvoices() {
            const history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
            const container = document.getElementById('invoicesList');
            const noInvoices = document.getElementById('noInvoices');

            if (history.length === 0) {
                container.innerHTML = '';
                noInvoices.classList.remove('hidden');
                return;
            }

            noInvoices.classList.add('hidden');
            container.innerHTML = history.map(inv => {
                const total = inv.items.reduce((sum, item) => {
                    const subtotal = item.quantity * item.price;
                    const vat = subtotal * (item.vat / 100);
                    return sum + subtotal + vat;
                }, 0);

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="font-bold text-lg text-blue-600">${inv.number}</span>
                                    <span class="text-sm text-gray-500">${formatDate(inv.date)}</span>
                                </div>
                                <p class="font-semibold text-gray-800">${inv.customer.name}</p>
                                <p class="text-sm text-gray-600">${inv.items.length} prodotti/servizi</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-600">${formatCurrency(total)}</p>
                                <button onclick="deleteInvoice(${inv.id})" class="mt-2 text-red-600 hover:text-red-700 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Elimina
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadDrafts() {
            const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '[]');
            const container = document.getElementById('draftsList');
            const noDrafts = document.getElementById('noDrafts');

            if (drafts.length === 0) {
                container.innerHTML = '';
                noDrafts.classList.remove('hidden');
                return;
            }

            noDrafts.classList.add('hidden');
            container.innerHTML = drafts.map(inv => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="font-bold text-lg text-orange-600">${inv.number}</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-semibold rounded">BOZZA</span>
                            </div>
                            <p class="font-semibold text-gray-800">${inv.customer.name}</p>
                        </div>
                        <div class="text-right space-x-2">
                            <button onclick="deleteDraft(${inv.id})" class="text-red-600 hover:text-red-700 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadCustomers() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const container = document.getElementById('customersList');
            const noCustomers = document.getElementById('noCustomers');

            if (customers.length === 0) {
                container.innerHTML = '';
                noCustomers.classList.remove('hidden');
                return;
            }

            noCustomers.classList.add('hidden');
            container.innerHTML = customers.map((customer, index) => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800 mb-1">${customer.name}</p>
                            ${customer.vat ? `<p class="text-sm text-gray-600">P.IVA: ${customer.vat}</p>` : ''}
                            <p class="text-sm text-gray-600">${customer.city || ''}</p>
                        </div>
                        <button onclick="deleteCustomer(${index})" class="text-red-600 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteInvoice(id) {
            if (confirm('Sei sicuro di voler eliminare questa fattura?')) {
                let history = JSON.parse(localStorage.getItem('invoiceHistory') || '[]');
                history = history.filter(inv => inv.id !== id);
                localStorage.setItem('invoiceHistory', JSON.stringify(history));
                loadStats();
                loadInvoices();
            }
        }

        function deleteDraft(id) {
            if (confirm('Sei sicuro di voler eliminare questa bozza?')) {
                let drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '[]');
                drafts = drafts.filter(inv => inv.id !== id);
                localStorage.setItem('invoiceDrafts', JSON.stringify(drafts));
                loadStats();
                loadDrafts();
            }
        }

        function deleteCustomer(index) {
            if (confirm('Sei sicuro di voler eliminare questo cliente?')) {
                let customers = JSON.parse(localStorage.getItem('customers') || '[]');
                customers.splice(index, 1);
                localStorage.setItem('customers', JSON.stringify(customers));
                loadCustomers();
            }
        }

        function formatCurrency(value) {
            return '€ ' + value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }
    </script>
</body>
</html>